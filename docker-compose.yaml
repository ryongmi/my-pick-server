version: '3.8'
#
# my-pick-server는 중앙 집중식 인프라(krgeobuk-infrastructure)를 사용합니다.
# MySQL과 Redis는 krgeobuk-infrastructure/docker-compose/docker-compose.yaml에서 제공됩니다.
#
# 실행 순서:
# 1. krgeobuk-infrastructure 먼저 시작: cd ../../krgeobuk-infrastructure/docker-compose/ && docker-compose up -d
# 2. my-pick-server 시작: npm run docker:local:up
#

services:
  server:
    image: krgeobuk/my-pick-server:local
    container_name: my-pick-server
    build:
      context: .
      dockerfile: Dockerfile
      target: local
    ports:
      - 8300:8300
      - 9233:9229 # Node.js 디버깅 포트
    env_file:
      - ./envs/.env.local
    environment:
      - TZ=Asia/Seoul
      - NODE_OPTIONS=--experimental-specifier-resolution=node
    volumes:
      - ./src:/app/src:cached # 소스 코드 동기화
      - ./logs:/app/logs # Log 동기화
      - ./tsconfig.json:/app/tsconfig.json # tsconfig도 동기화
      - ./nodemon.json:/app/nodemon.json # nodemon 설정도 동기화
      - /app/dist
      - /app/node_modules # 익명 볼륨
    networks:
      - krgeobuk-network # 중앙 인프라 접근 (MySQL, Redis)
      - msa-network # 마이크로서비스 간 통신
    restart: unless-stopped

networks:
  krgeobuk-network:
    external: true
    name: krgeobuk-network
  msa-network:
    external: true
